<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Products</title>
		<style>
			:root{--bg:#f5f7fb;--card:#fff;--muted:#6b7280;--accent:#0ea5a4;--danger:#ef4444}
			html,body{height:100%}
			body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;background:var(--bg);color:#0f172a}
			.wrap{max-width:1100px;margin:40px auto;padding:20px}
			header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
			h1{font-size:1.5rem;margin:0}
			#message{color:var(--muted);font-size:0.95rem}

			/* grid */
			.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px}

			/* card */
			.card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);overflow:hidden;display:flex;flex-direction:column}
			.media{height:160px;background:#eef2f7;display:flex;align-items:center;justify-content:center}
			.media img{max-width:100%;max-height:100%;object-fit:contain;display:block}
			.content{padding:14px 16px;display:flex;flex-direction:column;gap:8px}
			.meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
			.category{font-size:0.8rem;color:var(--muted);background:#f1f5f9;padding:6px 10px;border-radius:999px}
			.title{font-weight:600;font-size:1rem;margin:0}
			.stock{font-size:0.85rem;color:#064e3b;background:#ecfdf5;padding:6px 8px;border-radius:8px}
			.stock.low{background:#fff1f2;color:var(--danger)}

			/* loading */
			.spinner{width:20px;height:20px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:var(--accent);animation:spin 1s linear infinite}
			@keyframes spin{to{transform:rotate(360deg)}}

			/* empty */
			.empty{padding:30px;text-align:center;color:var(--muted)}

			/* small responsive tweaks */
			@media (max-width:420px){.media{height:120px}.wrap{padding:12px;margin:18px auto}}
		</style>
	</head>
	<body>
		<div class="wrap">
			<header>
				<h1>Products</h1>
				<div id="message"><span class="spinner" aria-hidden="true"></span> Loading…</div>
			</header>

			<main id="products" class="grid" aria-live="polite"></main>
			<div id="empty" class="empty" style="display:none">No products found.</div>
		</div>

		<script>
			(function(){
				const baseUrl = 'http://127.0.0.1:5000'
				const apiPath = '/api/products'
				const productsEl = document.getElementById('products')
				const messageEl = document.getElementById('message')
				const emptyEl = document.getElementById('empty')

				// simple SVG placeholder data URL
				const placeholder = `data:image/svg+xml;utf8,${encodeURIComponent(`
					<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400' viewBox='0 0 600 400'>
						<rect width='100%' height='100%' fill='%23eef2f7' />
						<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23838f99' font-family='Arial, Helvetica, sans-serif' font-size='28'>No image</text>
					</svg>
				`)}`

				function setMessage(text, isLoading){
					if(isLoading){
						messageEl.innerHTML = '<span class="spinner" aria-hidden="true"></span> ' + text
					} else {
						messageEl.textContent = text
					}
				}

				function createCard(p){
					const el = document.createElement('article')
					el.className = 'card'

					const media = document.createElement('div'); media.className = 'media'
					const img = document.createElement('img')
					if(p.pictures && p.pictures.length){
						// use first picture; ensure absolute URL
						const path = p.pictures[0].path || ''
						const url = path.startsWith('http') ? path : (baseUrl + path)
						img.src = url
						img.alt = p.name + ' image'
					} else {
						img.src = placeholder
						img.alt = 'No image available'
					}
					media.appendChild(img)

					const content = document.createElement('div'); content.className = 'content'
					const meta = document.createElement('div'); meta.className = 'meta'
					const cat = document.createElement('div'); cat.className = 'category'; cat.textContent = p.category?.name || 'Uncategorized'
					const stock = document.createElement('div'); stock.className = 'stock'; stock.textContent = p.stockQuantity + ' in stock'
					if(typeof p.stockQuantity === 'number' && p.stockQuantity <= 5) stock.classList.add('low')
					meta.appendChild(cat); meta.appendChild(stock)

					const title = document.createElement('h2'); title.className = 'title'; title.textContent = p.name

					content.appendChild(meta)
					content.appendChild(title)

					el.appendChild(media)
					el.appendChild(content)
					return el
				}

				async function load(){
					setMessage('Loading…', true)
					productsEl.innerHTML = ''
					emptyEl.style.display = 'none'

					try{
						const res = await fetch(baseUrl + apiPath, {cache: 'no-store'})
						if(!res.ok) throw new Error('HTTP ' + res.status)
						const json = await res.json()
						const data = Array.isArray(json.data) ? json.data : (Array.isArray(json) ? json : [])

						if(data.length === 0){
							emptyEl.style.display = 'block'
							setMessage('No products found', false)
							return
						}

						const frag = document.createDocumentFragment()
						for(const p of data){
							frag.appendChild(createCard(p))
						}
						productsEl.appendChild(frag)
						setMessage('Showing ' + data.length + ' product' + (data.length>1?'s':''), false)
					}catch(err){
						console.error(err)
						setMessage('Error loading products: ' + err.message, false)
						emptyEl.style.display = 'block'
						emptyEl.textContent = 'Failed to load products. Is the API running at ' + baseUrl + '?' 
					}
				}

				// initial load
				load()

				// optional: refresh on focus
				window.addEventListener('focus', () => { load() })
			})()
		</script>
	</body>
</html>
